<!DOCTYPE html>
<html lang="zh-cn">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>编译器的实现原理</title>
    <style>
        table {
            border-collapse: collapse;
        }

        td {
            border: 1px solid;
            padding: 0 1rem;
        }

        em {
            color: tomato;
        }

        .legend {
            display: inline-block;
            font-size: small;
        }
    </style>
</head>

<body>
    <p>小心,这是一堆抽象的东西</p>
    <h1>乔姆斯基体系(chomsky hierarchy)</h1>
    <p>提起编译原理,就不得不先说说文法。</p>
    <blockquote>
        <p>文法自然地描述了大多数程序设计语言构造的层次化语法结构</p>
        <footer> <cite>-编译原理(龙书)-p26</cite></footer>
    </blockquote>
    <p>假设我们要描述这样一个东西:"一个加法的数学表达式由两个数字和加号运算符组成",我们可以用如下的一条文法规则描述:</p>
    <math>
        <mi>EXP</mi>
        <mo>=></mo>
        <mi>num</mi>
        <mo>+</mo>
        <mi>num</mi>
    </math>
    <p>上面式子中的EXP表示一个表达式,num表示一个数字,所以"1+2"、"5+6"这些内容都符合EXP的展开规则,如果我们再扩展一下:</p>
    <ol>
        <li>
            <math>
                <mi>EXP</mi>
                <mo>=></mo>
                <mi>EXP</mi>
                <mo>+</mo>
                <mi>EXP</mi>
            </math>
        </li>
        <li>
            <math>
                <mi>EXP</mi>
                <mo>=></mo>
                <mo>(</mo>
                <mi>EXP</mi>
                <mo>)</mo>
            </math>
        </li>
        <li>
            <math>
                <mi>EXP</mi>
                <mo>=></mo>
                <mi>NUM</mi>
            </math>
        </li>
    </ol>
    <p>那么对于"1+(2+3)"这样的内容也完全符合上述文法规则,这个内容会被解析成如下的一颗语法树:</p>
    <svg style="height: 200PX;" data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 121.59 122.12"><text
            transform="translate(43.51 118.23)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">2</text><text
            transform="translate(35.26 99.02)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">NUM</text>
        <line x1="75.58" y1="71.34" x2="75.58" y2="63.34" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="75.58" y1="46.05" x2="75.58" y2="38.05" style="fill:none;stroke:#231815;stroke-miterlimit:10" /><text
            transform="translate(103.51 118.09)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">3</text>
        <line x1="39.98" y1="21.78" x2="39.98" y2="12.78" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="106.28" y1="90.04" x2="106.28" y2="85.04" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="46.93" y1="90.04" x2="46.93" y2="85.04" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="46.28" y1="107.07" x2="46.28" y2="102.07" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="106.28" y1="107.07" x2="106.28" y2="102.07" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <text transform="translate(94.26 99.02)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">NUM</text><text
            transform="translate(65.75 59.69)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">EXP</text><text
            transform="translate(95.75 82.02)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">EXP</text><text
            transform="translate(35.75 82.02)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">EXP</text><text
            transform="translate(8.25 71.06)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">1</text><text
            transform="translate(0 51.85)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">NUM</text>
        <line x1="11.02" y1="42.87" x2="11.02" y2="37.87" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="11.02" y1="59.9" x2="11.02" y2="54.9" style="fill:none;stroke:#231815;stroke-miterlimit:10" /><text
            transform="translate(0.5 34.85)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">EXP</text><text
            transform="translate(65.75 34.85)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">EXP</text><text
            transform="translate(30.5 10.3)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">EXP</text>
        <line x1="65.01" y1="38.05" x2="54.15" y2="46.09" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="25.07" y1="12.78" x2="14.21" y2="20.81" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="86.15" y1="38.05" x2="97.01" y2="46.09" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="54.9" y1="12.78" x2="65.75" y2="20.81" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="65.01" y1="63.33" x2="54.15" y2="71.36" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <line x1="86.15" y1="63.33" x2="97.01" y2="71.36" style="fill:none;stroke:#231815;stroke-miterlimit:10" /><text
            transform="translate(44.03 59.69)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">(</text><text
            transform="translate(104.03 59.69)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">)</text><text
            transform="translate(72.65 82.02)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">+</text><text
            transform="translate(36.35 34.85)"
            style="isolation:isolate;font-size:12px;fill:#231815;font-family:ArialMT, Arial">+</text>
    </svg>
    <p>接着上面用到的文法,再介绍几个名词:(以下内容参考wikiPedia的<q cite="https://en.wikipedia.org/wiki/Chomsky_hierarchy"><a
                href="https://en.wikipedia.org/wiki/Chomsky_hierarchy">Chomsky
                hierarchy</a></q>和<q><a href="https://en.wikipedia.org/wiki/Terminal_and_nonterminal_symbols">Terminal
                and nonterminal symbols</a></q>)</p>
    <ol>
        <li>开始符号(start symbol):一个特意指定的符号,表示整个文法结构。在上面的例子中没有特意在指定S,但是可以理解,我们最终会把整颗语法树规约成EXP,所以EXP就是上述文法的</li>
        <li>非终结符(non-terminal symbol):一个可以被推导(repalce)的符号。比如上面我们在解析"1+(2+3)"的时候把NUM推导成了2,把EXP推导成了(EXP+EXP)</li>
        <li>终结符(terminal symbol):一个不允许被推导的符号。如上面解析过程中的'+'、'('、')'都是不允许推导的。<em>在后面的内容中,将会用ε表示一个特殊的空终结符,这个符号表示什么内容都没有</em>
        </li>
        <li>产生式(production rule):指定了符号的推导规则。上面的两个文法定义,共4条规则都是产生式</li>
    </ol>
    <p>有了上述概念,我们可以模仿着写出java语言的if语句规则:(按照一些古老的习惯,我用大写字母表示非终结符,小写字母表示终结符,实际上这不是强制的)</p>
    <ol>
        <li>
            <math>
                <mi>STMT</mi>
                <mo>=></mo>
                <mi>if</mi>
                <mo>(</mo>
                <mi>EXP</mi>
                <mo>)</mo>
                <mi>STMT</mi>
            </math>
        </li>
    </ol>
    <p>上述规则可以描述这样的语句:</p>
    <code>
        <div>
            if ( condition ) stmt
        </div>
    </code>
    <p>甚至还可以表示if的嵌套:</p>
    <code>
        <div>
            if ( condition )
        </div>
        <div>
            &nbsp;&nbsp;if ( condition ) stmt
        </div>
    </code>
    <p>因为if语句本身又是一个STMT</p>
    <p>乔姆斯基体系将文法分为四个层级:0-型文法、1-型文法、2-型文法、3-型文法。对于0-型和1-型文法,我也没什么研究,简单了解一下即可,计算机编程语言主要使用的就是2-型文法(上下文无关文法)和3-型文法(正规文法)</p>
    <ol>
        <li>
            <span>0-型文法:</span>
            <p>Type-0 文法包括所有的形式文法。描述了所有可以被图灵机识别的语言。这些语言同时也被称为递归可枚举或图灵可识别的语言--
                <q cite="https://en.wikipedia.org/wiki/Recursively_enumerable_language">
                    <a href="https://en.wikipedia.org/wiki/Recursively_enumerable_language">
                        recursively enumerable or Turing-recognizable languages
                    </a>
                </q>
            </p>
        </li>
        <li>
            <span>1-型文法</span>
            <p>Type-1文法可以生成上下文相关语言,这种文法描述的语言可以使用线性有界自动机描述。--
                <q cite="https://en.wikipedia.org/wiki/Context-sensitive_grammar">
                    <a href="https://en.wikipedia.org/wiki/Context-sensitive_grammar">
                        Context-sensitive grammar
                    </a>
                </q>
            </p>
            <ol>
                <li>
                    <math>
                        <mi>α</mi>
                        <mi>A</mi>
                        <mi>β</mi>
                        <mo>=></mo>
                        <mi>α</mi>
                        <mi>γ</mi>
                        <mi>β</mi>
                    </math>
                </li>
                <li>
                    <math>
                        <mi>θ</mi>
                        <mi>A</mi>
                        <mi>λ</mi>
                        <mo>=></mo>
                        <mi>α</mi>
                        <mi>ξ</mi>
                        <mi>β</mi>
                    </math>
                </li>
            </ol>
            <p>同样的一个符号A,当他前面是α且后面是β时,才把A替换成γ,要是A的前面是θ后面是λ,则将其替换成ξ(即非终结符的替换需要考虑这个非终结符所在的上下文)</p>
        </li>
        <li>
            <span>2-型文法</span>
            <p>Type-2文法可生成上下无关语言,他的非终结符替换不需要考虑。--
                <q cite="https://en.wikipedia.org/wiki/Context-free_grammar">
                    <a href="https://en.wikipedia.org/wiki/Context-free_grammar">
                        Context-free_grammar
                    </a>
                </q>
            </p>
            <p>上下文无关文法的产生式规则如下:</p>
            <math>
                <mi>A</mi>
                <mo>=></mo>
                <mi>α</mi>
            </math>
            <p>一条即产生式规则的左侧有且仅有一个非终结符。我们可以发现这里不需要考虑这个非终结符的上下文,这为我们设计计算机编程语言提供了非常大的方便,比如C#中有这样一行代码</p>
            <div>a * b</div>
            <p>编译器可以立马识别到这是一个对象a和一个对象b进行了*操作,简单理解就是看到了符号*,那么他可以立即理解为*操作符。而这种语法在C/C++上,还需要考虑a是否为一种自定义类型,如果a是自定义类型的话,这行语句应当是声明一个指针。当然针对C/C++这种程度的上下文相关,我们可以对编译器做一些针对性调整,使其在输入阶段变为上下文无关。
            </p>
        </li>
        <li>
            <span>3-型文法</span>
            <p>Type-3文法也叫做正规文法(regular grammar),正规文法也分为左正规文法和右正规文法,他们之间没有多大差异。参考--<q
                    cite="https://en.wikipedia.org/wiki/Regular_grammar">
                    <a href="https://en.wikipedia.org/wiki/Regular_grammar">
                        Regular_grammar
                    </a>
                </q>
            </p>
            <p>一个右正规文法的产生式必须是如下的形式:</p>
            <ol>
                <li>
                    <math>
                        <mi>A</mi>
                        <mo>=></mo>
                        <mi>a</mi>
                    </math>
                </li>
                <li>
                    <math>
                        <mi>A</mi>
                        <mo>=></mo>
                        <mi>aB</mi>
                    </math>
                </li>
                <li>
                    <math>
                        <mi>A</mi>
                        <mo>=></mo>
                        <mi>ε</mi>
                    </math>
                </li>
            </ol>
            <p>如果把第二条规则定义成
                <math>
                    <mi>A</mi>
                    <mo>=></mo>
                    <mi>Ba</mi>
                </math>
                ,那么这个文法就是左正规文法。正规文法要求一个非终结符①要么能替换成一个终结符,②要么能替换成一个终结符和右侧的一个非终结符(如果这个非终结符在左侧,就是左正规文法),③或者这个非终结符能推导出一个空终结符。3-型文法的表达能力和正则表达式(regular
                expression)完全一致。比如我们写这样一个正则表达式"a*b",我们可以构造如下的3-型文法表示:
            </p>
            <ol>
                <li><math>
                        <mi>S</mi>
                        <mo>=></mo>
                        <mi>A</mi>
                        <mi>b</mi>
                    </math></li>
                <li><math>
                        <mi>A</mi>
                        <mo>=></mo>
                        <mi>a</mi>
                    </math></li>
                <li><math>
                        <mi>A</mi>
                        <mo>=></mo>
                        <mi>a</mi>
                        <mi>A</mi>
                    </math></li>
                <li><math>
                        <mi>A</mi>
                        <mo>=></mo>
                        <mi>ε</mi>
                    </math></li>
            </ol>
            <p>这也是3-型文法叫做正规文法的原因</p>
        </li>
    </ol>
    <p>乔姆斯基体系的每一层文法表达能力都涵盖了下一层,也就是随着数字的增加,文法的表达能力逐渐减小:</p>
    <svg style="height: 300PX;" data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 438.5 407.07">
        <ellipse cx="219.25" cy="218.02" rx="218.75" ry="188.54"
            style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <ellipse cx="219.25" cy="265.94" rx="157.29" ry="140.63"
            style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <ellipse cx="219.25" cy="310.38" rx="110.76" ry="96.18" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <ellipse cx="219.25" cy="344.76" rx="56.6" ry="61.81" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
        <g style="isolation:isolate"><text transform="translate(164.21 78.37)"
                style="isolation:isolate;font-size:24px;fill:#231815;font-family:ArialMT, Arial">Recursively
            </text><text transform="translate(164.21 107.17)"
                style="isolation:isolate;font-size:24px;fill:#231815;font-family:ArialMT, Arial">enumerable</text></g>
        <text transform="translate(137.72 191.55)"
            style="isolation:isolate;font-size:24px;fill:#231815;font-family:ArialMT, Arial">Context-sensitive</text><text
            transform="translate(159.4 255.99)"
            style="isolation:isolate;font-size:24px;fill:#231815;font-family:ArialMT, Arial">Context-free</text><text
            transform="translate(183.41 346.44)"
            style="isolation:isolate;font-size:24px;fill:#231815;font-family:ArialMT, Arial">Regular</text><text
            transform="translate(126.65 20.6)"
            style="isolation:isolate;font-size:24px;fill:#231815;font-family:ArialMT, Arial">Chomsky hierarchy</text>
    </svg>
    <p>通过上面的说明,我们可以知道一件有趣的事:<em>永远不可能用正则表达式判断一个字符串是否为一个合法的正则表达式</em></p>
    <h1>编译器结构</h1>
    <p>前面说了这么多铺垫,都是为了打一下基础。一般可以把编译器的分析-综合模型粗略的分为前端和后端(参考龙书第六章和第八章的开头)</p>
    <div style="width: 600px;text-align: center;">
        <svg data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 600.89 70.71"><text
                transform="translate(31.58 16.55)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">词法分析</text>
            <rect x="25.43" y="0.5" width="60.3" height="24.6" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <text transform="translate(120.31 16.55)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">文法分析</text>
            <rect x="114.16" y="0.5" width="60.3" height="24.6" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <text transform="translate(209.04 16.55)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">语义检查</text>
            <rect x="202.89" y="0.5" width="60.3" height="24.6" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <text transform="translate(297.6 16.55)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">中间代码生成</text>
            <rect x="291.62" y="0.5" width="83.97" height="24.6"
                style="fill:none;stroke:#231815;stroke-miterlimit:10" /><text transform="translate(522.41 16.55)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">目标代码生成</text>
            <rect x="516.42" y="0.5" width="83.97" height="24.6"
                style="fill:none;stroke:#231815;stroke-miterlimit:10" /><text transform="translate(410.01 16.55)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">中间代码优化</text>
            <rect x="404.02" y="0.5" width="83.97" height="24.6"
                style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <line x1="88.73" y1="12.8" x2="102.3" y2="12.8" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="100.32 15.7 111.16 12.8 100.32 9.89 100.32 15.7" style="fill:#231815" />
            <line y1="12.8" x2="13.57" y2="12.8" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="11.59 15.7 22.43 12.8 11.59 9.89 11.59 15.7" style="fill:#231815" />
            <line x1="177.46" y1="12.8" x2="191.03" y2="12.8" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="189.05 15.7 199.89 12.8 189.05 9.89 189.05 15.7" style="fill:#231815" />
            <line x1="266.19" y1="12.8" x2="279.76" y2="12.8" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="277.78 15.7 288.62 12.8 277.78 9.89 277.78 15.7" style="fill:#231815" />
            <line x1="378.59" y1="12.8" x2="392.16" y2="12.8" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="390.18 15.7 401.02 12.8 390.18 9.89 390.18 15.7" style="fill:#231815" />
            <line x1="490.99" y1="12.8" x2="504.56" y2="12.8" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="502.58 15.7 513.42 12.8 502.58 9.89 502.58 15.7" style="fill:#231815" />
            <line x1="389.81" y1="33.43" x2="389.81" y2="70.71" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <line x1="4.33" y1="64.76" x2="377.95" y2="64.76" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="375.96 67.67 386.81 64.76 375.96 61.86 375.96 67.67" style="fill:#231815" />
            <line x1="598.87" y1="64.76" x2="401.67" y2="64.76" style="fill:none;stroke:#231815;stroke-miterlimit:10" />
            <polygon points="403.65 61.86 392.81 64.76 403.65 67.67 403.65 61.86" style="fill:#231815" /><text
                transform="translate(193.81 61.72)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">前端</text><text
                transform="translate(483.84 61.72)"
                style="font-size:12px;fill:#231815;font-family:AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std">后端</text>
        </svg>
        <span class="legend">编译器模型</span>
    </div>
    <p>所以我们可以一步一步的剖析这些流程。</p>
    <h1>词法分析</h1>
    <p>编译器的词法分析阶段可以用很多技术,当然很多编译器都是使用正规语言作为一个词法分析器,因为正则表达式比较容易编写。考虑一下开始我们说的加法,如果我们要解析"1+(2+3)"这个源码,那么我们需要把这个输入依次转换为:</p>
    <table>
        <tbody>
            <tr>
                <td>num</td>
                <td>+</td>
                <td>(</td>
                <td>num</td>
                <td>+</td>
                <td>num</td>
                <td>)</td>
            </tr>
        </tbody>
    </table>
    <p>那么我们可以编写如下的正则规则:</p>
    <table>
        <tbody>
            <tr>
                <td>num</td>
                <td>[0-9]+</td>
            </tr>
            <tr>
                <td>left bracket</td>
                <td>'('</td>
            </tr>
            <tr>
                <td>right bracket</td>
                <td>')'</td>
            </tr>
            <tr>
                <td>add operator</td>
                <td>'+'</td>
            </tr>
        </tbody>
    </table>
    <p>所以首先需要做的就是实现我们自己的正则解析器。为了实现正则解析,可以借助两个工具NFA(non-deterministic finite automaton)和DFA(deterministic finite
        automaton)</p>
    <h2>NFA</h2>
    <p>NFA的定义很简单,满足如下几个条件即可</p>
    <ol>
        <li>有限的状态集合(finite的由来)</li>
        <li>输入字母表</li>
        <li>状态转换函数,定义了每一个状态对于字母表中字母的后继状态</li>
        <li>一个开始和结束状态</li>
    </ol>
    <p>这么说是不是很抽象,举个例子其实就很简单明了了,假设我们有如下一个nfa,我们说明一下NFA的工作机制。</p>
    <ol>
        <li>在最开始的时候,状态机总是处于start状态</li>
        <li>状态机总是记录着当前处于那些状态(一个状态集)</li>
        <li>如果当前状态集任意一条边(状态转移函数)能接受某个输入字母a,则将所有这些边的目标状态到一个集合中,并且使这个集合作为当前集合对于输入字母a的后继集合</li>
        <li>如果最终状态机停止的时候,当前状态集中包含了end状态,则说明这个NFA接受的输入的字符串</li>
    </ol>
    <p>需要特别注意的是:<em>ε表示一个空符号,如果ε出现在状态机的某条边上,表示可以无条件从前一个状态沿这条边到达后继状态</em></p>
    <p>在下面我做了动画演示,处理字母序列'aab'和'b'的情况</p>
    <div id="NFA-1">
        <template>
            <svg id="NFA-1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 625 189.22" style="height: 300px;">
                <defs>
                    <style>
                        .cls-1 {
                            fill: none;
                            stroke: #000;
                            stroke-miterlimit: 10;
                        }

                        .cls-2 {
                            font-size: 12px;
                        }

                        .cls-2,
                        .cls-3 {
                            font-family: AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std;
                        }

                        .cls-3 {
                            font-size: 18px;
                        }
                    </style>
                </defs>
                <g class="arrow" id="p_0_1">
                    <line class="cls-1" x1="105" y1="102.5" x2="141.14" y2="102.5" pathLength="100" />
                    <polygon points="139.16 105.4 150 102.5 139.16 99.59 139.16 105.4" />
                </g>
                <g class="arrow" id="p_1_2">
                    <line class="cls-1" x1="210" y1="102.5" x2="246.14" y2="102.5" pathLength="100" />
                    <polygon points="244.16 105.4 255 102.5 244.16 99.59 244.16 105.4" />
                </g>
                <g class="arrow" id="p_2_3">
                    <line class="cls-1" x1="315" y1="102.5" x2="351.14" y2="102.5" pathLength="100" />
                    <polygon points="349.16 105.4 360 102.5 349.16 99.59 349.16 105.4" />
                </g>
                <g class="arrow" id="p_3_4">
                    <line class="cls-1" x1="420" y1="102.5" x2="456.14" y2="102.5" pathLength="100" />
                    <polygon points="454.16 105.4 465 102.5 454.16 99.59 454.16 105.4" />
                </g>
                <g class="arrow" id="p_4_5">
                    <line class="cls-1" x1="525" y1="102.5" x2="561.14" y2="102.5" pathLength="100" />
                    <polygon points="559.16 105.4 570 102.5 559.16 99.59 559.16 105.4" />
                </g>
                <g class="arrow" id="p_2_1">
                    <path class="cls-1" d="M285,72.5C285,3.73,188.81.78,180.56,63.65" pathLength="100" />
                    <polygon points="177.87 61.48 180 72.5 183.66 61.89 177.87 61.48" />
                </g>
                <g class="arrow" id="p_0_3">
                    <path class="cls-1" d="M75,132.5q153.5,74.3,307,3.78" pathLength="100" />
                    <polygon points="381.33 139.62 390 132.5 378.93 134.33 381.33 139.62" />
                </g><text class="cls-2" transform="translate(230 94.45)">a</text><text class="cls-2"
                    transform="translate(544.48 94.45)">b</text><text class="cls-2"
                    transform="translate(226.5 10.56)">ε</text><text class="cls-2"
                    transform="translate(331.5 94.45)">ε</text><text class="cls-2"
                    transform="translate(436.5 94.45)">ε</text><text class="cls-2"
                    transform="translate(121.5 94.45)">ε</text><text class="cls-2"
                    transform="translate(226.5 186.18)">ε</text>
                <g class="state" id="state0">
                    <circle class="cls-1" cx="75" cy="102.5" r="25" /><text class="cls-3"
                        transform="translate(60.16 108.13)">start</text>
                </g>
                <g class="state" id="state1">
                    <circle class="cls-1" cx="180" cy="102.5" r="25" /><text class="cls-3"
                        transform="translate(175.84 108.13)">1</text>
                </g>
                <g class="state" id="state2">
                    <circle class="cls-1" cx="285" cy="102.5" r="25" /><text class="cls-3"
                        transform="translate(280.84 108.13)">2</text>
                </g>
                <g class="state" id="state3">
                    <circle class="cls-1" cx="390" cy="102.5" r="25" /><text class="cls-3"
                        transform="translate(385.84 108.13)">3</text>
                </g>
                <g class="state" id="state4">
                    <circle class="cls-1" cx="495" cy="102.5" r="25" /><text class="cls-3"
                        transform="translate(490.84 108.13)">4</text>
                </g>
                <g class="state" id="state5">
                    <path
                        d="M600,81a21.5,21.5,0,1,1-21.5,21.5A21.52,21.52,0,0,1,600,81m0-1a22.5,22.5,0,1,0,22.5,22.5A22.5,22.5,0,0,0,600,80Z" />
                    <path d="M600,78.5a24,24,0,1,1-24,24,24,24,0,0,1,24-24m0-1a25,25,0,1,0,25,25,25,25,0,0,0-25-25Z" />
                    <text class="cls-3" transform="translate(586.76 108.13)">end</text>
                </g>
                <g class="arrow" id="p_0_0">
                    <line class="cls-1" y1="102.5" x2="36.14" y2="102.5" pathLength="100" />
                    <polygon points="34.16 105.4 45 102.5 34.16 99.59 34.16 105.4" />
                </g>
            </svg>
            <div>
                <span>这里有上面NFA处理两个字符串的示意图,可以点击下一步观看</span><br />
                <table>
                    <tbody>
                        <tr>
                            <td><span>aab</span></td>
                            <td><button id="aab">下一步</button></td>
                        </tr>
                        <tr>
                            <td><span>b</span></td>
                            <td><button id="b">下一步</button></td>
                        </tr>
                    </tbody>
                </table>
                <span>当前状态集: </span><span id="now"></span><br />
                <span>当前可接受字母: </span><span id="letters"></span><br />
                <span>处理字母: </span><span id="letter" style="color: red;"></span><br />
            </div>
        </template>
    </div>
    <p>通过上面动画,我们可以发现这个nfa和正则表达式"a*b"是完全等价的,实际上任何基本正则表达式都是能完全转化为NFA的,他们的表达能力一致。基本正则是指没有加上开发者自己的扩展功能,比如匹配到单词"boom"就在屏幕放一个烟花,或者其他特殊语法。实际上一些扩展功能,比如分组匹配在nfa中也是存在的,在NFA转换成DFA的过程中会丢失一些信息使得类似分组匹配这些功能失效。基本正则简称BRE,被扩展过的叫做ERE。参考--
        <q cite="https://en.wikipedia.org/wiki/Regular_expression#Standards">
            <a href="https://en.wikipedia.org/wiki/Regular_expression#Standards">Regular expression</a>
        </q>
    </p>
    <p><em>这里我强调一下,对于BRE和ERE的标准定义我实在没精力去考古了,所以这里我只说一下我对BRE的理解,应该大差不差</em></p>
    <p>基本正则表达式只包含如下三种结构</p>
    <ol>
        <li>连接,如:abc就表示"a连接b得到的一个表达式再连接c",也就是解析这个式子之后得到的结构应该是这样的(ab)c</li>
        <li>并,如:a|b</li>
        <li>克林闭包,如:a*</li>
    </ol>
    <p>而类似a+这种语法是ERE里面才有的。</p>
    <h1>克林闭包(Kleene closure)</h1>
    <p>
        <a href="https://en.wikipedia.org/wiki/Kleene_star">克林闭包</a>
        在计算机科学中也扮演着重要的角色,不管是做正则引擎还是后面会说的上下文无关文法分析器,以及在关系数据库中计算一个关系R的候选码的时候,都会用到这个概念。
    </p>
    <h2>某个状态集合s的克林闭包的计算方法:</h2>
    closure(s)
    <ol>
        <li>for s 中的每一个项(状态)</li>
        <ol>
            <li>检测以该状态i为起点的所有ε边的目标状态t,如果t不存在于s,则将t添加到s中</li>
        </ol>
    </ol>
    <h1>正则表达式到NFA的转换</h1>
    <p>为什么要将正则表达式转换为NFA呢?<em>因为直接编写正则表达式的处理程序是比较困难的,借助NFA这种状态机的思想,我们就可以比较简单的通过状态转换实现正则表达式的功能。</em>有的编程语言在用正则表达式的时候会有一个编译步骤,比如java的Pattern.compile,编译过程一般就是将用户输入的正则表达式编译成状态机(这句话我不负法律责任,我凭经验猜的,所以前面加了"一般"两个字)
    </p>
    <p>前面已经提过,正则表达式和NFA的能力一致,所以存在将正则转换为NFA的方法。在本教程里面,我们只考虑基本正则表达式到NFA的转换。需要注意的是:<em>我在下面做的转换可能存在一些冗余,比如两个子表达式连接的时候,前一个子串的end状态和后一个子串的start状态也可以合并,所以我这种转换方法不是唯一解决方案。</em>
    </p>
    <ol>
        <li>
            <p>对于任何一个正则,我们可以构造这样一个NFA</p>
            <svg data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 270.5 51" style="height: 60px;">
                <defs>
                </defs>
                <style>
                    @scope {
                        .cls-1 {
                            fill: none;
                        }

                        .cls-1,
                        .cls-4 {
                            stroke: #231815;
                            stroke-miterlimit: 10;
                        }

                        .cls-2 {
                            font-size: 12px;
                            font-family: AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std;
                        }

                        .cls-2,
                        .cls-3 {
                            fill: #231815;
                        }

                        .cls-4 {
                            fill: #fff;
                        }
                    }
                </style>
                <circle class="cls-1" cx="70" cy="25.5" r="25" />
                <text class="cls-2" transform="translate(60.11 29.26)">start</text>
                <circle class="cls-1" cx="230" cy="25.5" r="25" />
                <circle class="cls-1" cx="230" cy="25.5" r="23" />
                <text class="cls-2" transform="translate(221.17 29.26)">end</text>
                <line class="cls-1" y1="25.5" x2="31.14" y2="25.5" />
                <polygon class="cls-3" points="29.16 28.41 40 25.5 29.16 22.59 29.16 28.41" />
                <line class="cls-1" x1="100" y1="25.5" x2="191.14" y2="25.5" />
                <polygon class="cls-3" points="189.16 28.41 200 25.5 189.16 22.59 189.16 28.41" />
                <rect class="cls-4" x="120" y="10.5" width="60" height="30" rx="5" />
                <text class="cls-2" transform="translate(126 30.69)">子表达式</text>
            </svg>
        </li>
        <li>
            <p>对于单个字母a,构造这样一个NFA</p>
            <svg data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 195.5 51" style="height: 60px;">
                <defs>

                </defs>
                <style>
                    @scope {
                        .cls-1 {
                            fill: none;
                            stroke: #231815;
                            stroke-miterlimit: 10;
                        }

                        .cls-2 {
                            font-size: 12px;
                            font-family: AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std;
                        }

                        .cls-2,
                        .cls-3 {
                            fill: #231815;
                        }
                    }
                </style>
                <circle class="cls-1" cx="70" cy="25.5" r="25" />
                <text class="cls-2" transform="translate(60.11 29.26)">start</text>
                <circle class="cls-1" cx="170" cy="25.5" r="25" />
                <circle class="cls-1" cx="170" cy="25.5" r="23" />
                <text class="cls-2" transform="translate(161.17 29.26)">end</text>
                <line class="cls-1" y1="25.5" x2="31.14" y2="25.5" />
                <polygon class="cls-3" points="29.16 28.41 40 25.5 29.16 22.59 29.16 28.41" />
                <line class="cls-1" x1="100" y1="25.5" x2="131.14" y2="25.5" />
                <polygon class="cls-3" points="129.16 28.41 140 25.5 129.16 22.59 129.16 28.41" />
                <text class="cls-2" transform="translate(117.5 17.45)">a</text>
            </svg>
        </li>
        <li>
            <p>子表达式α连接β时,构造这样一个NFA</p>
            <svg data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 515.5 51" style="height: 60px;">
                <defs>

                </defs>
                <style>
                    @scope {
                        .cls-1 {
                            fill: none;
                        }

                        .cls-1,
                        .cls-4 {
                            stroke: #231815;
                            stroke-miterlimit: 10;
                        }

                        .cls-2,
                        .cls-5 {
                            font-size: 12px;
                        }

                        .cls-2,
                        .cls-3,
                        .cls-5 {
                            fill: #231815;
                        }

                        .cls-2 {
                            font-family: AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std;
                        }

                        .cls-4 {
                            fill: #fff;
                        }

                        .cls-5 {
                            font-family: DengXian;
                        }
                    }
                </style>
                <circle class="cls-1" cx="70" cy="25.5" r="25" />
                <text class="cls-2" transform="translate(60.11 29.26)">start</text>
                <circle class="cls-1" cx="230" cy="25.5" r="25" />
                <text class="cls-2" transform="translate(221.17 29.26)">end</text>
                <line class="cls-1" y1="25.5" x2="31.14" y2="25.5" />
                <polygon class="cls-3" points="29.16 28.41 40 25.5 29.16 22.59 29.16 28.41" />
                <line class="cls-1" x1="100" y1="25.5" x2="191.14" y2="25.5" />
                <polygon class="cls-3" points="189.16 28.41 200 25.5 189.16 22.59 189.16 28.41" />
                <rect class="cls-4" x="120" y="10.5" width="60" height="30" rx="5" />
                <text class="cls-5" transform="translate(122.42 28.85)">子表达式α</text>
                <circle class="cls-1" cx="330" cy="25.5" r="25" />
                <text class="cls-2" transform="translate(320.11 29.26)">start</text>
                <circle class="cls-1" cx="490" cy="25.5" r="25" />
                <circle class="cls-1" cx="490" cy="25.5" r="23" />
                <text class="cls-2" transform="translate(481.17 29.26)">end</text>
                <line class="cls-1" x1="260" y1="25.5" x2="291.14" y2="25.5" />
                <polygon class="cls-3" points="289.16 28.41 300 25.5 289.16 22.59 289.16 28.41" />
                <line class="cls-1" x1="360" y1="25.5" x2="451.14" y2="25.5" />
                <polygon class="cls-3" points="449.16 28.41 460 25.5 449.16 22.59 449.16 28.41" />
                <rect class="cls-4" x="380" y="10.5" width="60" height="30" rx="5" />
                <text class="cls-5" transform="translate(382.42 28.85)">子表达式β</text>
                <text class="cls-5" transform="translate(277.37 17.46)">ε</text>
            </svg>
            <p>我们把表达式α的结束状态和表达式β的开始状态用一条ε边连接得到一个新的状态机,然后以α的开始状态作为新状态机的开始,以β的结束状态作为新状态机的结束状态。</p>
        </li>
        <li>
            <p>两个子表达式α、β并联的时候(α|β),构造这样一个NFA</p>
            <svg style="height: 150px;" data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 486.31 106">
                <defs>

                </defs>
                <style>
                    @scope {

                        .cls-1,
                        .cls-3 {
                            fill: none;
                        }

                        .cls-1,
                        .cls-7 {
                            stroke: #231815;
                        }

                        .cls-1,
                        .cls-3,
                        .cls-7 {
                            stroke-miterlimit: 10;
                        }

                        .cls-2,
                        .cls-4,
                        .cls-8,
                        .cls-9 {
                            font-size: 12px;
                        }

                        .cls-2,
                        .cls-6,
                        .cls-8 {
                            fill: #231815;
                        }

                        .cls-2,
                        .cls-4 {
                            font-family: AdobeSongStd-Light-GBpc-EUC-H, Adobe Song Std;
                        }

                        .cls-3 {
                            stroke: #e60012;
                        }

                        .cls-4,
                        .cls-5,
                        .cls-9 {
                            fill: #e60012;
                        }

                        .cls-7 {
                            fill: #fff;
                        }

                        .cls-8,
                        .cls-9 {
                            font-family: DengXian;
                        }
                    }
                </style>
                <circle class="cls-1" cx="182.8" cy="25.5" r="25" />
                <text class="cls-2" transform="translate(172.91 29.26)">start</text>
                <circle class="cls-3" cx="70" cy="53" r="25" />
                <text class="cls-4" transform="translate(60.11 56.76)">start</text>
                <circle class="cls-1" cx="342.8" cy="25.5" r="25" />
                <text class="cls-2" transform="translate(333.98 29.26)">end</text>
                <line class="cls-3" x1="98.03" y1="48" x2="144.61" y2="28.87" />
                <polygon class="cls-5" points="143.88 32.31 152.8 25.5 141.67 26.93 143.88 32.31" />
                <line class="cls-1" x1="212.8" y1="25.5" x2="303.94" y2="25.5" />
                <polygon class="cls-6" points="301.96 28.41 312.8 25.5 301.96 22.59 301.96 28.41" />
                <rect class="cls-7" x="232.8" y="10.5" width="60" height="30" rx="5" />
                <text class="cls-8" transform="translate(235.22 28.85)">子表达式α</text>
                <line class="cls-3" x1="372.8" y1="25.5" x2="419.29" y2="44.63" />
                <polygon class="cls-5" points="416.35 46.56 427.48 48 418.56 41.19 416.35 46.56" />
                <line class="cls-3" y1="53" x2="31.14" y2="53" />
                <polygon class="cls-5" points="29.16 55.91 40 53 29.16 50.09 29.16 55.91" />
                <text class="cls-9" transform="translate(397.51 32.08)">ε</text>
                <text class="cls-9" transform="translate(122.79 32.08)">ε</text>
                <text class="cls-9" transform="translate(122.79 64.58)">ε</text>
                <circle class="cls-1" cx="182.8" cy="80.5" r="25" />
                <text class="cls-2" transform="translate(172.91 84.26)">start</text>
                <circle class="cls-1" cx="342.8" cy="80.5" r="25" />
                <text class="cls-2" transform="translate(333.98 84.26)">end</text>
                <circle class="cls-3" cx="460.81" cy="53" r="25" />
                <circle class="cls-3" cx="460.81" cy="53" r="23" />
                <text class="cls-4" transform="translate(451.99 56.76)">end</text>
                <line class="cls-3" x1="98.03" y1="58" x2="144.61" y2="77.13" />
                <polygon class="cls-5" points="141.67 79.07 152.8 80.5 143.88 73.69 141.67 79.07" />
                <line class="cls-1" x1="212.8" y1="80.5" x2="303.94" y2="80.5" />
                <polygon class="cls-6" points="301.96 83.41 312.8 80.5 301.96 77.59 301.96 83.41" />
                <rect class="cls-7" x="232.8" y="65.5" width="60" height="30" rx="5" />
                <text class="cls-8" transform="translate(235.22 83.85)">子表达式α</text>
                <line class="cls-3" x1="372.8" y1="80.5" x2="419.29" y2="61.37" />
                <polygon class="cls-5" points="418.56 64.81 427.48 58 416.35 59.44 418.56 64.81" />
                <text class="cls-9" transform="translate(397.51 64.58)">ε</text>
            </svg>
            <p>我们创建了一个新的start状态和end状态作为新状态机的开始、结束状态(红色),然后从新start创建两条ε边,分别连接到原来子串的start状态。从原来两个子串的end状态各创建一条ε边连接到新end状态
            </p>
        </li>
        <li>
            <p>求子表达式α克林闭包(α*)的时候,构造这样一个NFA</p>
            <svg style="height: 300px;" data-name="图层 1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 455.5 208.9">
                <defs>

                </defs>
                <style>
                    @scope {

                        .cls-1,
                        .cls-3 {
                            fill: none;
                        }

                        .cls-1,
                        .cls-6 {
                            stroke: #231815;
                        }

                        .cls-1,
                        .cls-3,
                        .cls-6 {
                            stroke-miterlimit: 10;
                        }

                        .cls-2,
                        .cls-4,
                        .cls-7,
                        .cls-9 {
                            isolation: isolate;
                            font-size: 12px;
                        }

                        .cls-2,
                        .cls-5,
                        .cls-7 {
                            fill: #231815;
                        }

                        .cls-2,
                        .cls-4 {
                            font-family: ArialMT, Arial;
                        }

                        .cls-3 {
                            stroke: #d71718;
                        }

                        .cls-4,
                        .cls-8,
                        .cls-9 {
                            fill: #d71718;
                        }

                        .cls-6 {
                            fill: #fff;
                        }

                        .cls-7,
                        .cls-9 {
                            font-family: DengXian;
                        }
                    }
                </style>
                <circle class="cls-1" cx="170" cy="87.97" r="25" />
                <text class="cls-2" transform="translate(160.11 91.72)">start</text>
                <circle class="cls-3" cx="70" cy="87.97" r="25" />
                <text class="cls-4" transform="translate(60.11 91.72)">start</text>
                <circle class="cls-1" cx="330" cy="87.97" r="25" />
                <text class="cls-2" transform="translate(321.17 91.72)">end</text>
                <line class="cls-1" x1="200" y1="87.97" x2="291.14" y2="87.97" />
                <polygon class="cls-5" points="289.16 90.87 300 87.97 289.16 85.06 289.16 90.87" />
                <rect class="cls-6" x="220" y="72.97" width="60" height="30" rx="5" />
                <text class="cls-7" transform="translate(222.42 91.3)">子表达式α</text>
                <line class="cls-3" y1="87.97" x2="31.14" y2="87.97" />
                <polygon class="cls-8" points="29.16 90.87 40 87.97 29.16 85.06 29.16 90.87" />
                <line class="cls-3" x1="100" y1="87.97" x2="131.14" y2="87.97" />
                <polygon class="cls-8" points="129.16 90.87 140 87.97 129.16 85.06 129.16 90.87" />
                <line class="cls-3" x1="360" y1="87.97" x2="391.14" y2="87.97" />
                <polygon class="cls-8" points="389.16 90.87 400 87.97 389.16 85.06 389.16 90.87" />
                <text class="cls-9" transform="translate(377.37 79.93)">ε</text>
                <text class="cls-9" transform="translate(117.37 79.93)">ε</text>
                <text class="cls-9" transform="translate(244.66 205.86)">ε</text>
                <text class="cls-9" transform="translate(248.14 9.7)">ε</text>
                <circle class="cls-3" cx="430" cy="87.97" r="25" />
                <circle class="cls-3" cx="430" cy="87.97" r="23" />
                <text class="cls-4" transform="translate(421.17 91.72)">end</text>
                <path class="cls-3" d="M298.61,170.13c68.28,95.2,279.29,97.53,354.58,7"
                    transform="translate(-228.61 -52.16)" />
                <polygon class="cls-8" points="425.6 128.29 430 117.97 421.03 124.71 425.6 128.29" />
                <path class="cls-3" d="M558.61,110.13c0-50.56-142.12-53.47-158.47-8.73"
                    transform="translate(-228.61 -52.16)" />
                <polygon class="cls-8" points="169.22 46.77 170 57.97 174.92 47.88 169.22 46.77" />
            </svg>
            <p>
                我们创建了一个新的start状态和end状态作为新状态机的开始、结束状态(红色),然后从新start创建两条ε边,分别连接到原子串的start和新的end状态。从原子串的end状态创建两条ε边,分别连接到原来子串的start状态和新end状态
            </p>
        </li>
    </ol>
    <p>通过上述几种基本的正则规则,我们可以实现一些扩展正则功能,比如"a+bc"这个正则表达式识别的是"以一个或者多个a开头,后面再连接bc两个字母",我们可以用"aa*bc"这个基本正则表达式描述</p>
    <h1>DFA</h1>
    <p>NFA在运行的时候,我们需要不断的计算闭包,这个过程比较消耗内存和CPU,看上面demo中的NFA运行示意图,我们进入start状态或者输入一个字母a之后,还得不断地搜索当前集合能通过ε边达到的新状态。存在一个简化NFA处理机制的方法,我们可以把NFA转换为DFA(deterministic
        finite automaton)。需要注意的是:<em>在NFA转换为DFA的过程中,其实并没有简化运算,但是在转换完成之后,速度将会直接起飞。</em></p>
    <p>当前NFA转换成DFA的过程也很简单,我们只要按照如下步骤循环进行就可以了</p>
    <ol>
        <li>首先给closure(start)作为DFA的唯一状态,然后令当前状态集(now)为closure(start)</li>
        <li>扫描当前状态集中所有的非ε边,设该边为字母a
            <ol>
                <li>将所有a指向的后继状态添加到next状态集中</li>
                <li>检查clouser(next)是否已经存在于DFA中
                    <ul>
                        <li>如果closure(next)没有存在于DFA,则将closure(next)添加到DFA中。并在now创建一条边a指向closure(next)</li>
                        <li>如果closure(next)已经存在于DFA,则直接now创建一条边a指向closure(next)</li>
                    </ul>
                </li>
            </ol>
        </li>
        <li>不断地重复步骤2,直到没有任何新状态集出现</li>
    </ol>
    <p>在这里我制作了将上面"a*b"对应的NFA转换成DFA的动画,可以点击下一步观看</p>
</body>

<script type="module" src="./js/NFA-1.js">
</script>

</html>